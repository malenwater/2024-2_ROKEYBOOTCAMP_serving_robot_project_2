# 2024-2_ROKEYBOOTCAMP_serving_robot_project_2
본 프로젝트는 ROS2를 활용하여 재난 구조 로봇을 개발하고, Mapping, 탐색, 객체 탐지(Detection) 및 좌표 변환을 통한 맵 반영을 구현하는 것을 목표로 합니다.

## 🚀 Use ROS2 Package
- 터틀봇4를 실행할 준비 (Slam, nav2, rviz2 실행 방법)
  1. 깃 클론을 한다. 레포지토리 위치로 이동한다.
  2. ws/com_sh/v4 위치에 들어간다.
  3. 터미널 3개를 띄워 각각 아래 명령어를 입력한다.

          . rviz2.sh  
          . slam.sh 
          . nav.sh  

- 오토맵핑 py 파일 실행 방법<br/>
  1. ws/src/robot_cleaner/robot_cleaner/map_ss_mapping.py 를 실행한다.<br/>
- pnp py 파일 실행 방법<br/>
  1. ws/src/robot_cleaner/robot_cleaner/detect_img_pose.py 를 실행한다.<br/>
## ✨ Key Features

- **동적 탐색 알고리즘**:  <br/>
  로봇이 SLAM으로 생성된 지도에서 가장 먼 미지의 영역을 식별하고 순차적으로 탐색합니다.
- **파라미터 최적화**:  <br/>
  좁은 경로에서도 원활한 탐색이 가능하도록 매개변수를 조정했습니다.
- **효율적인 커버리지**:  <br/>
  불필요한 중복을 최소화하면서 모든 미지의 공간을 탐색합니다.
- **PnP 기반 위치 식별, TR 변환으로 SLAM 맵 좌표 변환**: <br/>
  TR 변환과 PNP를 활용하면 SLAM 맵 기준 -> base_link → camera → 소화기/사람의 위치를 변환할 수 있다.

## 진행한 프로젝트 리뷰
 - **로봇 청소기 오토 맵핑** <br/>
   turtleBot4의 slam과 nav2 기능을 이용해서 폭이 일정한 환경에서 자동으로 맵핑이 되도록 한다. 좁은 곳을 통과하기 위한 slam, nav2 튜닝과 점을 찍기 위한 이동 로직이 중요하다.
   <br/>
    - slam, nav2의 파라미터 튜닝을 통해서, 좁은 곳과 벽 뒤에 넘어가는 경우, 맵이 깨지는 경우 등을 해낼 수 있다. <br/>
    - nav2가 올바른 이동을 위해서 밝혀지지 않은 공간(-1), 밝혀진 공간(0), 벽(100) 중 이동 가능한 밝혀지지 않은 공간의 옆 밝혀진 공간으로 충분히 이동 가능할 경우, nav2를 찍도록 하는 로직을 수행한다. <br/>
 - **PNP를 통한 slam map에 물체 위치 나타내기**
   PNP란 3D 현실 좌표계를 카메라상 2D 이미지 위치를 보고, 카메라가 해당 점까지의 좌표계(TR)을 추리해주는 알고리즘이다. 이를 활용하여 로봇으로 부터 인지한 이미지(소화기, 쓰러진 사람)을 디텍팅하고 해당 이미지의 위치를 slam map에 띄우도록 한다.
   - 핵심 개념으로 slam map 좌표계 기준 base_link pose TR과 base_link 좌표계 기준 camera pose TR과 camera 좌표계 기준 img pose TR(PNP)를 각각 구하여 연산하여 구하는 것이 중요하다. 

## 겪었던 문제사항과 해결 방법들
  - slam map이 auto mapping 중 부셔지는 문제(튜닝 문제)
    - auto mapping을 하던 중, 갑자기 맵이 여러개가 곂치면서 부셔지는 문제가 발생했습니다. 해당 문제의 원인으론 수업에서 배웠던 slam의 loop closure가 동작하여 문제로 보였습니다. 그래서 slam.yaml의 loop_search_maximum_distance의 값을 3m에서 1m로 변경해서, 각각의 모서리가 비슷하여 loop close를 할려는 현상을 거리 제한을 두어 해결하였습니다.
  - nav2의 이동이 벽 뒤를 찍을 경우, 이동하지 못하는 문제(튜닝 문제)
    - 해당 문제는 nav2가 벽 뒤를 가는 경로가 복잡하기 때문에 계속해서 경로를 생성하여 문제가 있었습니다. 그래서 sim_time 이라는 값을 높여 해결했습니다. 해당 값은 터틀 봇이 경로를 설정할 때 최대 몇초 뒤까지를 계산하고 이동할지를 결정하는 것으로 이 값이 높을 수록 복잡한 경로를 잘 해쳐나가지만 눈 앞의 장애물을 피하기 힘든 등의 문제가 생겼습니다.
  - nav2의 이동이 좁은 곳을 찍을 경우, 이동하지 못하는 문제 (튜닝 문제)
    - 해당 문제는 nav2의 경로가 용암(지나가지 못하는 공간)을 타는 듯한 경로를 짜기 때문에 터틀봇이 이를 지나가다 라이더 센서가 값을 받을 때, 용암이 커지면서 이동하지 못하였습니다. 해당 문제는 global cost map의 값을 올리기 위해 cost를 높여 경로를 용암이 아닌 안전 구역을 타도록 하여 해결 하였습니다.
  - PNP의 로직은 맞지만, 계속해서 벽이 아닌 벽 앞에 이미지가 있다고 인식하는 문제 (PNP 문제)
    - 해당 문제는 로직상 맞지만 지속해서 이미지의 위치가 벽이 아닌 벽 앞으로 인식하는 문제였습니다. 해당 문제는 로봇에서 주는 K가 문제로 제공해주는 화각은 약 202이지만 실제론 약 390 화각이 올바른 화각으로 이를 바꿀 경우, 벽에 이미지가 붙어 있는 것을 확인하여 문제를 해결할 수 있었습니다.

## 🎥 Demo Video
- [터틀봇4 자동 맵핑 영상](https://youtu.be/OAdRA_p5VME)
- [소화기 및 쓰러진 사람 이미지 위치 영상](https://youtube.com/shorts/we-peWtMpCA?feature=share)

